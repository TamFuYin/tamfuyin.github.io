---
layout: default
title: [省选联考 2025] 岁月
permalink: /blog/-sheng-xuan-lian-kao--2025--sui-yue/
---

希望大家一直记得[我](https://www.luogu.com.cn/problem/P10221)。
“希望大家永远*忘了我*。”

# [省选联考 2025] 岁月

最后悔的一道题。早知道先去做 T3 了。

初看时很激动，因为我做过主旋律这道题。然而，终于对图计数不甚熟悉，做了 2h 无果，只好打了性质 A 走人。

你先思考**存在外向生成树**意味着什么，外向生成树的根能够到达图中所有点，于是意味着强连缩点后只有一个入度为零的 SCC，这个 SCC 中所有点都可以作为根，显然这是充要的。

## 性质 B

只存在唯一一个最小生成树，那么我们就可以把其他边扔掉，反正不可能成为所需的外向生成树。赛时没把容斥搞懂，其实不用容斥，根据上面的结论，只需要保证枚举的可以的根节点之间强连通，即连接它们的边都是双向边，而其它边都是单向边即可。

## 性质 C

所有边相同，于是只需要存在外向生成树即可。

依然考虑枚举所有的可能的根节点集合。

需要满足它们强连通，这个的方案数就是众所周知的[主旋律](https://uoj.ac/problem/37)。

还得满足他们能够到达其他的所有点。

考虑容斥，枚举不能到达的点集 $T$，那么有
$$
\sum_{T\subseteq S\backslash R}2^{-E(S\backslash T,T)}dp_{S\backslash T}=1
$$
其中 $dp_{S}$ 表示 $R$ 能够到达 $S$ 的概率。

即
$$
dp_S=1-\sum_{T\subseteq S\backslash R,T\neq\varnothing}2^{-E(S\backslash T,T)}dp_{S\backslash T}
$$
注意到我们的 dp 相当于统计从 $R\subseteq x\subseteq U$ 的每个点开始到 $U$ 的路径权值和，其中一条路径的权值是每条边的权值之积，从 $S\backslash T$ 到 $S$ 的边的权值为 $-2^{-E(S\backslash T,T)}$。

那么我们可以倒着 DP，统计从 $U$ 开始到每个点的路径权值和，然后做个超集卷积即可。

## 正解

根据 kruskal 的算法可以知道，所有的最小生成树，$\forall x$，在仅保留长度 $\le x$ 的边时，其连通情况（即任意两个点之间的连通情况）都相同。

因此我们按照长度自小到大考虑每条边是否加入，这时每个时刻的连通情况我们是知晓的。

每个时刻我们会加入一些长度都等于 $x$ 的新边，一条新边能够加入当且仅当它能够改变连通情况（即，如果这条边连接了两个本来就在一个连通块内的点，那么这条边是没用的）。

因此

- 每个时刻一个方案形如若干个连通块，每个连通块内都存在一个强连通的点集 $R$，满足它能够到达这个连通块内的其他点。不同连通块之间不存在任何连边（即它们是弱连通块）
- 每个时刻需要把若干个连通块合并成一个大的连通块，这个新的连通块的 $R$ 一定来自于旧的连通块中的 $R$，而且一个旧的连通块中的 $R$ 如果能够保留，那么该旧连通块所有的 $R$ 都能被保留。

记 $cs_S$ 表示点集 $S$ 所出现的连通块的集合。

记 $dp_S$ 表示从 $R$ 出发能够到达 $cs_S$ 中的所有点，并且每个连通块内选择的根集恰好为 $S$。

记 $be_S$ 表示 $cs_S$ 选择的根集的并集恰好为 $S$ 的概率。其实就是上一轮的答案。

那么枚举 $T$ 所在的连通块不能到达，且选择的根集恰为 $T$，则
$$
\sum_{T\subseteq S,cs_T\not\cap cs_{S\backslash T}}2^{-E(cs_{S\backslash T},T)}be_{T}dp_{S\backslash T}=be_S
$$
即
$$
dp_S=be_S-\sum_{T\subseteq S\backslash R,cs_T\not\cap cs_{S\backslash T},T\ne \varnothing}2^{-E(cs_{S\backslash T},T)}be_{T}dp_{S\backslash T}
$$
用相同的方法处理即可做到 $O(3^n\mathrm{poly}(n))$

