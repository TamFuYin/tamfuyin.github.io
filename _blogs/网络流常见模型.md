---
layout: default
title: 网络流常见模型
permalink: /blog/wang-luo-liu-chang-jian-mo-xing/
---

本文立志于消除一切几何直觉，从代数角度建立网络流。

# 线性规划表述

$m$ 个范围为 $[0,w_i]$ 的变量，$n$ 个包含这些变量的等式，且满足一个变量在这些等式的左边或者右边最多出现一次。

### 忘记名字的例题，好像在 24 题里面，懒得找了

树上差分以减少变量出现次数。

### [Marbles](https://codeforces.com/gym/103855/problem/I)

注意到它形成了一个类似树的结构，每个点上的不等式包含了它的叶子除去其子树内扔掉的变量，因此每个变量可能出现多次。

对每个树上的点都建一个变量，那么 $a_i+\sum_{j\in del_i} a_j=\sum_{j\in son_i} a_j$，题目中的不等式可以直接对这个变量进行作用，因此跑一个上下界网络流即可。

# 二分图匹配

常见技巧是拆点，可以表示命题之间的关系。

### [AGC034D](https://www.luogu.com.cn/problem/AT_agc034_d)

暴力是两两连边跑二分图最大价值最大匹配。

因为是最大化，所以 $(x,y)$ 到 $(z,w)$ 的曼哈顿距离可以写为 $\max(x-z,z-x)+\max(y-w,w-y)=\max(x+y-z-w,x-y-z+w,-x+y+z-w,-x-y+z+w)$。

这告诉我们其实总共只有四种匹配方式，而价值是可拆的，在中间加四个虚点即可。

### [AGC031E](https://www.luogu.com.cn/problem/AT_agc031_e)

~~虽然也不是二分图但也放到这里来了。~~

题目的约束很难绷，但是可以转化为「横/纵排名为 $b_i$ 的人的横/纵坐标 $\ge$/$\le a_i$」，进一步地，枚举总的选的人的个数，可以知道横/纵坐标为 $x$ 的人的横/纵坐标排名范围。

此时可以化为一个三分图匹配的问题，每个人在左侧与其横坐标排名匹配，在右侧与其纵坐标排名匹配。

要求最大价值和，把中间的点拆掉即可点权化为边权。

### [DAG 最小链覆盖](https://www.luogu.com.cn/problem/P2764)

拆点后，可以转化为头点和尾点的二分图匹配，可以用线性规划来得到。

### Dilworth 定理

给定一个偏序集，其最长反链等于其最小链覆盖。

### [CF1630F](https://www.luogu.com.cn/problem/CF1630F)

显然图为二分图当且仅当（保留的点，整除关系）这一偏序集的最长链不超过 $2$，即每个点要么为因数，要么为倍数。注意到多数情况下命题都是相容的，而命题的相悖只在发生整除关系时发生。考虑以此拆点建立二分图，连边当且仅当两个命题相悖，则答案为其最大独立集。二分图最大独立及=|V|-二分图最小点覆盖=|V|-二分图最大匹配。这一结论也可以用 Dilworth 定理得到。

### Hall 定理

二分图存在完美匹配当且仅当 $\forall S\subseteq L,|N(S)|\ge |S|$。

推广：二分图最大匹配 $=|L|+\min_{S\subseteq L}(|S|-|N(S)|)$。

### [[PKUSC2022] 撸猫](http://jiang.ly/problem/12015)

题目大意：给定一个概率分布函数 $P$。你要对每个 $S\subseteq [n]$ 都设计一个在 $S$ 上的概率分布函数 $b_{S,i},i\in S$，记 $p_i=\sum_{S\subseteq P}[i\in S]P_S$，你要最大化 $c$，使得 $\forall i,\sum_{S\subseteq [n]}P_Sb_{S,i}\ge c\cdot p_i$。

二分答案，则左侧容量为 $c\cdot p_i$，右侧容量为 $P_S$。

对于左侧任意一个 $T\subseteq [n]$，其邻域 $N(T)=\{S|S\cap T\ne \varnothing\}$，只要使 $\sum_{S\in N(T)} P_S\ge \sum_{i\in T} c\cdot p_i$，$c$ 即合法。

事实上不需要二分，直接求 $\min_{T\subseteq [n]}\dfrac {\sum_{S\in N(T)} P_S}{\sum_{i\in T}p_i}$ 就好了。$N(T)$ 可以用容斥+高维后缀和来算。
$$
\begin{aligned}
\sum_{S\cap T\ne \varnothing} a_S
&=\sum_S a_S[S\cap T\ne \varnothing]\\
&=\sum_S a_S \sum_{\varnothing\ne A\subseteq S\cap T} (-1)^{|A|-1}\\
&=\sum_{\varnothing\ne A\subseteq T} (-1)^{|A|-1}\sum_{S\supseteq A} a_S\\
\end{aligned}
$$

# 最小割

$n$ 个取值为 $\{0,1\}$ 的变量，$m$ 条形为「若 $u_i$ 取 $0$ 且 $v_i$ 取 $1$ 则代价为 $w_i$」的约束，其中 $u_i$/$v_i$ 可以为空，此时用源点/汇点代替。$w_i=\infin$ 被用于刻画禁止关系。

### 最大权闭合子图

### [AGC038F](https://www.luogu.com.cn/problem/AT_agc038_f)

把排列转化为置换环，则每个非自环的环有两种选择。$P$ 和 $Q$ 之间的贡献需要讨论一下。

- $P_i=Q_i=i$：只有一种选择，预处理掉
- $P_i=i,Q_i\ne i$：当 $b_i=0$ 时有贡献。
- $P_i\ne i,Q_i=i$：类似
- $P_i=Q_i\ne i$：当 $a_i=b_i$ 时有贡献，可以拆成 $a_i=b_i=0$ 和 $a_i=b_i=1$ 两条边。
- $P_i\ne i,Q_i\ne i,P_i\ne Q_i$：当 $a_i=b_i=0$ 时有贡献。

注意到 $4$ 和 $5$ 不满足我们的要求，但是只要把 $b$ 取反即可。

### [[HNOI2013] 切糕](https://www.luogu.com.cn/problem/P3227)

把每个平面上的点拆成值域个点，表示 $[f(i,j)\ge k]$，则若 $f(i,j)\ge k$ 且 $f(i,j)<k+1$ 则有 $v(i,j,k)$ 的代价。另外还应有 $f(i,j)\ge k$ 且 $f(i,j)<k-1$ 的禁止，不过这道题似乎不需要，参见谷上的第一篇题解。

令 $(i',j')$ 为 $(i,j)$ 一邻点。若 $f(i,j)\ge k$ 则有 $f(i',j')\ge k-D$，因此禁止 $f(i,j)\ge k$ 且 $f(i',j')<k-D$。同时若 $f(i,j)<k$ 则有 $f(i',j')<k+D$，因此禁止 $f(i,j)<k$ 且 $f(i',j')\ge k+D$，~~不过只需要简单的变量代换就会发现这句话是多余的了~~。

### [ARC176E](https://www.luogu.com.cn/problem/AT_arc176_e)

当 $A_i$ 取 $X$ 时，$X_j\ge A_{i,j}$，$Y$ 同理。因此可以设两种变量：$A_i$ 的取法和 $X,Y$ 的大小。

剩下的跟上一题差不多。

### [CF786E](https://www.luogu.com.cn/problem/CF786E)

对每条链及每条边设变量，可以用 ST 表优化建边。