---
layout: default
title: QOJ13631
permalink: /blog/qoj13631/
---

连着碰到好几道广义线段树题，就姑且写一下吧（傲娇脸

拆位？存在询问 4，位之间不独立，不可行。

先考虑如果是在正常的线段树上时该怎么做。

维护区间与以及区间取反之后的区间与，标记包括覆盖标记和翻转标记。

询问看起来很奇怪，我们需要进一步观察它的性质。

注意到对于任意一段路径，父节点总是子节点的子集，因此相当于每次往当前点集合中添加若干个数。

由此我们发现，当前点集合不同的数量其实很少，如果当前点集合相同，那么可以肯定这条链是「直」的。也就是说，最多存在 $\log$ 次路径弯曲。我们可以通过二分，在 $\log^2$ 的时间内完成路径的遍历。二分时需要 check 一条路径上是否所有节点都是相同的，事实上，我们只需要比较两个端点是否相同即可。

但是这里我们还涉及一个标记的问题。

我一开始想用[经典结论](https://www.luogu.com.cn/problem/P5210)，$[l,r]$ 在线段树上的区间，恰为 $l-1$ 和 $r+1$ 形成的路径包围形成的若干子树。设 $u$ 是 $l-1$ 往上跳到 LCA 的上一个点，$v$ 同理。即为 $l-1\sim u$ 的右兄弟子树和 $r+1\sim v$ 的左兄弟子树。但是仔细一想就会发现根本维护不了。

其实你会发现，如果放到 DFS 序上这个东西就是一段区间，即 $[\mathrm{dfn}_l,\mathrm{dfn}_r]$。所以直接放到线段树上维护就好了，二分时需要单点求值。

现在你的时间复杂度是三只牢哥，过不了一点~~大概还不如根号~~。

不过你发现你把倍增换成树剖就可以变成两只牢哥了。为什么呢？树剖看起来不是很优，因为它不是直的，但是你发现它最多增加 $\log$ 段。

可是对它树剖意味着必须重新 DFS 序标号。这是无妨的，因为我一开始看错题了，题目保证「给出的区间一定是线段树上某个节点所代表的」……

但是我一开始还想错了，单点修改之后是需要修改整个子树和祖先的。子树操作就是区间操作，祖先操作还是跳树链，但是你发现其实更新不了。怎么办呢？注意到这道题有一个很好的性质——二叉树。这意味着每个点至多有一个轻儿子。所以你每个点维护它的轻儿子的权值，特殊地，对于链底点维护它本身的值，那么某个点的值就是后缀与。跳树链时只需要修改 $O(\log n)$ 个点。

我们不需要在线段树上维护区间和，因为我们已经知道路径上每个点的值了。