---
layout: default
title: 襍
permalink: /blog/za/
---

私わ猫です

## AT_ddcc2020_qual_e

记 $f_i$ 表示询问 $[i,i+N-1]$ 的答案。

注意到 $f_1$ 与 $f_{N+1}$ 必然是不同的，所以必然存在一个分界点 $f_i$ 与 $f_{i+1}$ 不同。

不妨令 $f_i$ 赤球多，$f_{i+1}$ 青球多。

那么 $i$ 必然是赤球，$i+N$ 必然是青球。

删掉这两个球之后形成一个 $N-1$ 的子问题。

但是直接做的询问次数是 $O(N^2)$ 的，做不了，怎么办？

不过题目好像没说是适应性的，所以每次 shuffle 一下 没准能过？

有一个很神秘的 trick：注意到对于任意 $i$，$f_i$ 与 $f_1$ 和 $f_{N+1}$ 必然有一个不同。

所以可以二分！

这样询问次数就是 $O(N\log N)$ 的，貌似还是过不了。

注意到区间 $[i,i+N-1]$ 赤球与青球数量相等，依托这个区间，我们可以求出任意一个球的颜色！

然后就做完了，询问次数是 $O(1+\log N+N)$

## CF196E

求出关键点之间的以最短路径为边权的完全图的最小生成树，再加上 $1$ 到最近的关键点的距离即可。

考虑跑多源最短路，对于每条边 $(u,v)$，找到离 $u$ 最近的关键点 $x$ 和离 $v$ 最近的关键点 $y$，对 $(x,y)$ 连边 $dis(x,u)+w+dis(y,v)$，然后跑 Kruskal 即可。

## P10868

随机二叉树。

我想知道，$n$ 个叶子的二叉树个数有多少个？不难发现就是 Catalan 数 $C_{n-1}$

那么，记 $f_{l,r}$ 表示 $[l,r]$ 的所有可能的二叉树的权值的期望。

$$
f_{l,r}=\sum_{i=l}^{r-1}\frac{C_{i-l}C_{r-i-1}}{C_{r-l}}(f_{l,i}+f_{i+1,r})/2\\
f_{i,i}=x_i
$$

大概就是这个样子……

好像做不太了。

考虑拆贡献？

设 $f_{i,j}$ 表示前面 $i$ 个数，后面 $j$ 个数的期望系数。

那么有
$$
\begin{aligned}
f_{i,j}&=\frac{i-1}{i+j}f_{i-1,j}+\frac{j-1}{i+j}f_{i,j-1}+\frac{1}{2(i+j)}(f_{i-1,j}+f_{i,j-1})\\
&=\frac{2i-1}{2(i+j)}f_{i-1,j}+\frac{2j-1}{2(i+j)}f_{i,j-1}
\end{aligned}
$$

你发现大概是一个格路计数的形式，对于每一条格路，分母是 $(2(i+j))!!$，分子是 $(2i-1)!!(2j-1)!!$。

这里，我们认为 $(-1)!!=1$

所以
$$
f_{i,j}=\frac{(2i-1)!!(2j-1)!!(i+j)!}{(2(i+j))!!i!j!}
$$

所以预处理一下阶乘和双阶乘就做完了。

## CF1682E

考虑置换环，那么一个优秀的交换操作一定会把一个环拆成两个。

手玩一下样例，你发现需要按照旋转的方向处理 swap。

然后可以建图跑拓扑序。

## CF773D

求完全图的生成树，使得每个点的祖先路径最小值之和最小，对每个可能的根都求出答案。

首先我们找到最短的一条边，假设这条边的长度为 $w$，那么可以证明当根选在这条边的端点时答案能取到最小值 $(n-1)w$。

那么，我们的目标就是通过若干条边到达这几个点之一。

凭直觉，你发现这几条边，除了最后一条边一定是单调递减的。因为我们多走几条边就是为了降低走最后一条边的代价。

如何证明？如果一个地方递增了，我们还不如直接一步跳到那几个点。

考虑从「那几个点」开始把答案更新到其它点。

设 $f_i$ 为答案。那么初始化为
$$
f_i\gets w(i,x)-w
$$

表示只走一条边。其中 $x$ 为「那些点」之一

或者
$$
f_i\gets \min_{w(i,j)<w(j,x)}w(i,j)-w
$$

表示走两条边。

然后由于每条边是递减的，所以它都是「真实的」，可以看作路径和，所以在这个上面跑多源最短路即可。

注意到边权形如 $w(i,j)-w$ 非负，所以不会出现环。

## P8330

貌似这种与「出现次数」相关的题都是根号分治……

称出现次数 $\ge B$ 的数为大数；否则为小数。

考虑大数在外侧，则枚举每个大数 $x$，然后枚举剩下的大数/小数 $y$，则选择区间 $[l,r]$ 的贡献为 $[l,r]$ 内 $y$ 的数量减去 $x$ 的数量。

你发现端点只会出现在 $y$ 出现的地方，所以可以做到每个大数均摊 $O(N)$。

大数在内侧同理，所以我们只需要考虑小数和小数的贡献。

考虑钦定一个小数放在外面，那么可能的内侧区间只有 $O(B^2)$ 个，那么我们总共需要求 $O(NB)$ 次区间众数。

考虑扫描线，维护 $b_i$ 表示 $[i,r]$ 的众数出现次数。

考虑加入 $a_r$，要求 $a_r$ 的出现次数 $<B$。

找到 $a_r$ 在前面的所有出现位置 $l$，然后用 $[l,r]$ 的 $a_r$ 的出现次数来更新 $b_{1\sim l}$ 的值。

注意到由于 $b$ 事减函数，而且 $b_1<B$，所以更新（ckmax）的部分是一个区间，而且总更新次数是 $O(NB)$ 级别的！

所以可以暴力做，维护一个 $c_i=j$ 表示 $b_j\ge i$ 最大位置。

由于内存慷慨地给到了 **1GB**，所以可以离线做，时空复杂度 $O(N\sqrt N)$。

## CF1768F

CDQ 分治+李超树？等等好像做不了

注意到 $(j-i)^2\ge (j-k)^2+(k-i)^2$，所以其实比较碎的区间比较优。

特别地，我们令 $a_k=\min a_{i\sim j}$，然后直接就更优了。

所以说一个好的转移，最小值必然在端点上，而且是严格的最小值。

你还注意到这种情况下每步跳一次肯定比较好。

注意到题目给出 $a_i\le n$。

令一个端点 $a_i$，其步长为 $d$，则 $a_id^2\le dn$，所以我们发现 $d\le n/a_i$。

直接做就可以做到 $O(n\sqrt n)$。

考虑根号分治证明：
- 对于 $a_i\ge \sqrt n$，则 $d\le \sqrt n$
- 否则，我们把 $a_i$ 相同的元素一起考虑，我们发现以他们为最小值的区间不交，因此转移的总和为 $O(N\sqrt N)$

太妙了！！！

## AT_arc045_d

皆さん都很<ruby>好<rt>仲良</rt></ruby>呢

实际上，只要每个连通分量的大小是偶数，就必然存在完美匹配。貌似可以归纳证明

虽然直接建图是不行的，但是我们建出来一个圆方树即可，所以象征性地连一个环即可。

建出来圆方树之后就很好做了

## P9731

最神秘

考虑 $k=1$ 时怎么做？

如果评测机 $i$ 有题目 $u,v$ 就连一条边 $(u,v)$，用这条边的方向来决定排列。

那么要求每个点的入度与出度最多相差 $1$。

显然这**永远**是合法的，所以只要在图中随便搜出来欧拉回路/欧拉路径即可。

对于 $k>1$，考虑猜一个结论，就是必然存在一个合法解，使得任意题目在前 $S/2$ 次评测与后 $S/2$ 次评测的数量相差 $1$。

那么考虑如何用出度刻画在前 $S/2$ 次评测的出现次数，用入度刻画在后 $S/2$ 次评测的出现次数。

考虑再猜一个结论：我们**任意**两两连边都必然存在合法解。

然后跑一遍这个算法就知道在每个评测机，每次评测应该分到哪个位置，于是形成两个 $S/2$ 的子问题。这样就做完了

## P8276

很厉害的题目。

考虑一层层化简问题。

首先所有零度点（下文度均指出度）上假若放了指示物，那么就一定没法移动，所以将其删除，然后会产生新的零度点，也将其删去。

现在图上所有点度数至少为 $1$。

考虑找到一个度数为 $1$ 的点 $x$，假若其唯一的出边指向 $y$ 满足 $x\ne y$，我们发现 $x,y$ 上不可能同时存在指示物，因为那时 $x$ 无法移动，因此发现此时 $x,y$ 实际上处于一个等价的状态，考虑直接删掉边 $x→y$ 再合并两个点，边集直接 set 启发式合并维护。

现在图上所有点要么度数大于等于 $2$ 要么存在自环，对于两个指示物的初始位置，如果有一个位置被删掉或者两个位置被合并到一个点上都是无法无限移动，否则我们可以证明一定可以无限移动。

证明考虑对于一个放在有自环的位置上的指示物，可以无限走自环，否则由于一个点至少有两个出边，所以另一个指示物最多挡住一个，因此可以无限移动。

总时间复杂度 $O(n\log^2 n)$。

## P10104

考虑没有图的限制能不能做。

考虑数位 DP。

设 $f_{i,S}$ 表示目前 DP 到第 $i$ 位，且集合 $S$ 中的元素「贴上界」的方案数。

则
$$
f_{i,S}=\sum_{T\supseteq S}[a_{T\backslash S}\text{ is }1\text{ at the }i\text{-th bit}][|T|\ne n\lor \text{the xor sum of the }i\text{-bit of }a_{S}\text{ equals the }i\text{-th bit of }C]2^{n-|T|-1}f_{i+1,T}
$$

然后可以考虑图的限制。

发现「 $\ne$ 」的限制有点难搞，考虑容斥为「 $=$ 」。

考虑一个 $n$ 个元素的划分 $S_1,S_2,\dots,S_k$，每个划分内元素相等。

那么它违反的限制个数为 $E(S_1)+E(S_2)+\dots+E(S_k)$，其中 $E$ 表示导出子图的边数。

如果 $|S_i|$ 是偶数，则无论其如何选择都不对 $C$ 产生贡献，因此可以直接看作其不存在而乘上一个 $\min a_{S_i}+1$ 的系数，否则，$a'_i=\min a_{S_i}$ 而跑一遍上面的 $f$ 即为系数。

由于划分之间是无序的，所以最后还要乘一个 $\dfrac1{k!}$ 的系数？

没必要，我们只要保证 $\operatorname{lowbit}$ 递减即可。

但是 $f$ 这个东西还是太抽象了，貌似不太支持动态增加一个 $a$。

---

其实算这个有一个 $O(n\log V)$ 的做法的……

你发现让异或和 $=C$ 与让异或和 $=0$ 并无本质区别。

实际上两个问题是可以相互转化的。

我们让 $a_{n+1}=C$，求出此时异或和 $=0$ 的方案数，再减去 $a_{n+1}=C-1$，此时异或和 $=0$ 的方案数。

现在我们假设 $C=0$。

经典地，我们把 $\le a_i$ 的限制拆成钦定一个前缀，然后一个后缀任选。

因此不妨从前到后枚举。

假设我们已经通过神秘方法通过钦定前缀把 $>d$ 的二进制位的异或和变成 $0$ 了。显然初始时是可以满足的。

如果现在已经有一个元素，可以在 $\le d$ 的二进制位任选了，那么后面无论怎么选都是可以满足的。否则我们发现它前面一定是「贴上界」的，所以状态数是线性而非指数级的。

这里我们记 $a_{i}^{(d)}=a_i/2^d\bmod 2$，$\sum$ 表示异或和。

我们记 $s=\sum_{i=1}^n a_i^{(d)}$ 表示第 $d$ 层所有元素的异或和。

假设我们钦定 $S\ne \varnothing$ 中的元素不贴上界，要求 $a_i^{(d)}=1,i\in S$。

那么产生 $2^{d(|S|-1)}\prod_{i\notin S} (a_i\bmod 2^d+1)$ 的贡献。

但是我们选的这个 $S$ 还有一个条件，就是选出来之后 $\sum b_i^{(d)}=0$。

不难发现可以 $O(n)$ DP 出来。

设 $f_{i,0/1,0/1}$ 表示 DP 到第 $i$ 位，选出来的 $S$ 是否非空，以及目前的 $\sum b_i^{(d)}$。

如果我们发现 $d$ 这一位所有元素的异或和非零，那么下一位就不用做了。

特殊地，当 $d=0$ 时，我们是允许 $S=\varnothing$ 的。

这要求 $\sum a_i=0$，并产生 $1$ 的贡献系数，特殊搞一下即可。

其实这里不做 $C=0$ 的变换也行。

---

现在我们可以动态加入 $a$ 了。

注意到我们依旧对于每一位分别计算。

所以直接改成 $g_{S,0/1,0/1}$ 即可。

但是你发现我们的容斥假掉了，因为算重了，我们可能会给不同的等价类赋相同的值。

换言之，我们希望找到**极大的**子集划分进行转移，我们称之为「子集划分容斥」。

---

> 我们有一个关于等价类的系数 $F(x)$，而我们的 DP 不能恰好刻画每一个极大等价类（即可能存在相互等价的等价类），记等价类之间的合并关系 $G(x)$，则我们设计容斥系数 $H(x)$ 使 $G(H(x))=F(x)$

实际上并不是什么新奇的东西，我们已经在**DAG 容斥**中见过她了。

$$
f_S=\sum_{\varnothing\ne T\subseteq S}(-1)^{|T|-1}f_{S\backslash T}g_T
$$

DAG 容斥时，我们其实需要在图中找一个**极大的**入度为零的子集删掉。

记 $[x^S]F(x)$ 表示一个极大的入度为 $0$ 的点集 $S$ 需要贡献的系数，显然 $[x^S]F(x)=[S\ne \varnothing]$。

而合并关系为任意次的集合无交并 $\mathrm{SEQ}_{\ge 1}$，所以 $G(x)=\frac{1}{1-x}-1$，所以 $\frac{1}{1-H(x)}-1=F(x)$。

可以得出 $(1-H(x))(\sum_S x^S)=1$，可以用子集容斥瞪出 $1-H(x)=\sum_S (-1)^{|S|}x^S$。

所以我们才知道 $[x^S]H(x)=[S\ne \varnothing](-1)^{|S|-1}$。

---

而这里与 DAG 容斥有何不同？

答曰：DAG 容斥是有序的划分，我们这里是无序的划分，也就是说，如果划了 $k$ 段，则需要除以 $k!$。

显然我们这里的 $G(x)=\exp x-1$，然后我们的 $[x^S]F(x)$ 等于 $1$ 当且仅当 $S$ 是独立集。

所以不难看出 $H(x)=\ln(1+F(x))$。可以直接求出。

所以直接乘上这个容斥系数即可。

## P11803「この花が咲く時」

最神秘

特殊性质给了跟没给一样

不难想到在重链上维护 ODT，但是我们不知道如何给它打 tag。

考虑找一个代表元？

不妨钦定深度最浅的哪个点是代表元。

考虑一种类似线段树上 pushdown 的方法，在重链剖分上 pushdown。

具体来说，我们找到代表元所在重链，然后在块与重链的交上打一个 tag。

查询时，我们从根开始遍历，然后依次把标记下传，这样就是对的了。

修改颜色时同样，我们把上面的所有 tag 清空，然后就是对的。

颜色段用 ODT 维护即可。

## P13758「夏终」

神秘算法。我称之为「Kruskal 重构链」

考虑在 Kruskal 时，对每个连通块维护一条链，当合并两个连通块时即把两条链首尾相连。

那么在最小生成树上加边时，等价于在这条链上加边。

其实这个就是 Kruskal 重构树上的中序遍历。你加边的时候，该跨过的东西都跨过了，所以是对的。

因此原问题转化为 A 性质。

考虑 $E'$ 的边，发现形如一个菊花，花心是 $b$ 最小的点，记为 $x$，记 $C'=C+b_x$。

于是考虑选择的 $E$ 中的边，发现形如若干区间，代价为对于每个不含 $x$ 的区间 $S$ 的 $\min_{i\in S} b_i+C'$。

看到这个区间性质，你发现很好 **DP**。

记 $w_i$ 为连接 $i-1$ 和 $i$ 的边的边权，设 $f_{i,j,0/1}$ 为考虑 $[1,i]$，有 $j$ 个联通块，最后一个联通块 仍未计算/已经计算 的最小代价和。

然后转化为 min+ 卷积做闵可夫斯基和即可。

## AT_agc036_d

逆炼差分约束 %%%

初始约束形如

$$
x_i\ge 0
$$

すぬけさん给出的约束形如

- 对任意区间，区间和 $\ge 1$，代价为 $A_{l,r+1}$，不妨记为 $A[l,r]$
- 对任意区间，区间和 $\le 1$，代价为 $A_{r+1,l}$，不妨记为 $B[l,r]$

りんごくん希望存在合法解。

显然 $x_i\in\{0,1\}$。

考虑 DP，设 $f_{i,j}$ 表示 $i$ 要选，上一次选的是 $j$，且满足前 $i$ 个上面的区间约束的最小代价。

初始化为 $f_{0,0}=f_{1,0}=0$。

转移为
$$
f_{i,j}=\min_{0\le k<j}\{f_{j,k}+w(i,j,k)\}
$$

其中 $w(i,j,k)=\sum_{u=j+1}^{i-1}(\sum_{v=1}^kB[v,u]+\sum_{v=u}^{i-1}A[u,v])+\sum_{u=1}^{j}B[u,i]$。

发现基本形如矩形求和的形式，所以预处理二维前缀和即可，直接做时间复杂度 $O(N^3)$，如果是 Atcoder 的话我只能说确实有可能过。

考虑对每个 $j$ 维护当前最优决策，则可见其每次会加入 $w(i,j,k)-w(i-1,j,k)=\sum_{v=1}^k B[v,i-1]+\sum_{u=j+1}^{i-1}A[u,i-1]+\sum_{u=1}^{j}(B[u,i]-B[u,i-1])$。

第 2、3 项与 $k$ 无关，可以直接无视。

但是第一项是对每个 $k$ 加一个 $B[i-1,k]$ 的前缀和，注意到权为正，所以肯定选 $k=0$ 最优。

## P9479

观察 1 条件，发现 $T$ 是 $T'$ 的一棵虚树。

条件 2 为：$\operatorname{LCA}(i,j)\le \max(i,j)+k$。

不妨考虑 $k=0$ 的部分分怎么做。

则 $\mathrm{LCA}(i,j)\le \max(i,j)$。

考虑对每个 LCA 其约束是什么：它的每个子树内最小值的次小值编号 $\ge$ 它，也即不存在两个子树内包括 $<$ 它的编号，也即最多有一个子树内包括 $<$ 它的编号。

考虑从小到大加入节点，发现要么当叶子，要么插在一条边的中间，因此系数为 $n+n-1$。

然后考虑 $k$ 任意的情况，我们放宽了限制。

最多有一个子树内包括 $<$ 它的编号 $-k$ 的元素。

你发现序比较乱，但是 $k\le 10$，所以考虑**状压 DP**。

为了方便，我们设 $f_{i,S}$ 表示包含编号 $[1,i]\cup S$，其中 $S\subseteq[i+1,i+k]$ 的方案数。

然后有三种转移：

- $f_{i+1,S\backslash \{i+1\}}\gets f_{i,S}$，要求 $i+1 \in S$
- $f_{i+1,S}\gets (2(i+|S|)-1)f_{i,S}$，加入 $i+1$，要求 $i+1\notin S$
- $f_{i+1,S\cup \{j\}}\gets (i+|S|-1)f_{i,S}$，意思是：把一个 $j$ 插入边中，然后把 $i+1$ 挂在上面。要求 $i+1,j\notin S$，$j\in[i+2,i+k+1]$

然后就能不重不漏地统计所有情况。

## P9041

复习一下 LGV 引理。

---

$\omega(P)$ 表示 $P$ 上边权之积。

$e(u,v)$ 表示 $u$ 到 $v$ 每一条路径的 $\omega$ 之和，即 $e(u,v)=\sum_{P:u\to v}\omega(P)$

给定起点集合 $A$，终点集合 $B$。

则 LGV 引理计数一组 $A\to B$ 的不相交路径 $S$，每条路径 $S_i$ 从 $A_i$ 指向 $B_{\sigma_S(i)}$，其中 $\sigma_S$ 是一个排列。

记 $t$ 表示逆序对个数函数

LGV 引理：

$$
M=
\begin{bmatrix}
e(A_1,B_1)&e(A_1,B_2)&\cdots&e(A_1,B_n)\\
e(A_2,B_1)&e(A_2,B_2)&\cdots&e(A_2,B_n)\\
\vdots&\vdots&\ddots&\vdots\\
e(A_n,B_1)&e(A_n,B_2)&\cdots&e(A_n,B_n)\\
\end{bmatrix}\\

\det M=\sum_{S:A\to B}(-1)^{t(\sigma_S)}\prod_{i=1}^n\omega(S_i)
$$
---

回到这一题，我们考虑枚举 $[1,k]$ 的一个子集 $S$，然后枚举 $[k+1,n]$ 的长度为 $|S|$ 的区间 $[l,r]$，如果存在 $S\to [l,r]$ 的不交路径，就给 $g[l,r]\gets k$。

那么我们想求的 $f[l,r]=\max_{l\le u\le v\le r}g[u,v]$。

但是 LGV 引理带一个逆序对的容斥系数，怎么办？注意到我们只需要求**是否**存在即可，所以我们可以给边权一个随机的哈希，然后判断 $\det$ 是否非零即可。

还是做不了。注意到我们只需要判断 $\det$ 是否非零，换句话说就是 $M$ 是否满秩。

然后你发现你区间移动的过程，相当于每次加入一个向量然后删掉一个向量，判断是否满秩。

注意到一般的高斯消元还是太麻烦了，既然我们都用上哈希了，不妨改成异或哈希，然后就是所谓的线性基。

所以用一个带删线性基维护即可做到 $O(2^kn\operatorname{poly}(k))$。

如何规避枚举 $[1,k]$ 的子集？

显然我们可以把整个 $k\times k$ 的矩阵拉过来，每次问列一个区间，行任取，是否存在一个子矩阵满秩。

显然我们只需要这些列的行向量的基的大小 $=r-l+1$ 即可。不需要枚举子集。

然后就能做到 $O(nk^2)$ 左右，10s 能过了。

## AT_arc184_e

相当于问使 $A_i(1-x)^{-k}=A_j$ 的最小的 $k$

前缀和没有差分好算，所以转化为 $A_i=A_j(1-x)^k$。

我们来考察这个 $(1-x)^k=\sum_{i=0}^k\binom{k}{i}x^i=\sum_{i=0}^k[i\subseteq k]x^i$。

考虑能否对 $k$ 做二进制拆分，如果操作 $2^p$ 次，则 $(1-x)^{2^p}=1+x^{2^p}$。

考虑连边 $A\to A(1-x)$，我们发现每个点的入度和出度皆为 $1$，因此由若干个环构成。

考虑在每个环中取出一个代表元，并求出每个环的长度，然后就能解决这个问题了。

怎么找一个 $A$ 的代表元？我们认为它是环内字典序最小的元素。

考虑 $A$ 中最小的 $1$ 的位置 $t$，则 $A_t$ 始终为 $1$。

所以我们从小到大枚举 $p$，每次根据当前 $A_{t+2^p}$ 值考虑是否进行 $(1-x)^{2^p}$ 操作，然后就是对的。

现在对每个元素的代表元做一遍哈希分类，即可知道在哪个环内。

注意到我们顺便还求出了每个元素到代表元的距离。

我们还想求出环长。

注意到整个环的 $t$ 都是相同的。

找到使 $t+2^e\le m$ 的最大的 $e$，则必然存在一个元素，能够操作 $1,2,4,\dots,2^e$，也即距离为 $2^{e+1}-1$。

因此环长为 $2^{e+1}$。特别地，对于全 $0$ 序列，其周期为 $1$。

然后用一个树状数组统计即可。

## P10001

考虑 DP

$$
f_{i,j}=\min_{k=0}^{b_i}\{f_{i,j+k-\lfloor(a_i-k)/c\rfloor}+a_i-k\}
$$

直接做好像不太行。

考虑先观察些性质。

注意到每个优惠券能减少的金币量是一定的。

所以我们实际上希望调整的是：

- $(a_i-x)\bmod c$ 尽量少
- 用掉的优惠券尽量多

---

所以考虑设 $f_{i,j}$ 表示总共获得了 $j$ 张优惠券，最大化当前用掉的优惠券数量。

$$
f_{i,j}+x\to f_{i+1,j+\lfloor (a_i-x)/c\rfloor}\\
\text{where }0\le x\le \min(b_i,j+m-f_{i,j})
$$

设第 $i$ 次用掉的优惠券数量 $x_i$，考虑这个方案的合法性。

$$
\forall i,m+\sum_{j=1}^{i-1}\left(\left\lfloor\frac{a_j-x_j}{c}\right\rfloor-x_j\right)\ge x_i
$$

记等式左边为 $s_{i-1}$。

考虑一开始一张优惠券也不用，此时最后会多出若干张优惠券。

如果在前面用了若干张优惠券，那么在过程中总获得的优惠券数量（包括中间用了的）会减少。

考虑贪心，使减少的「总获得的优惠券数量」最少，「总获得的优惠券数量」记为 $S$。

考虑在一个物品上不断增加使用的优惠券，则可分为三个阶段：

- $[0,a_i\bmod c]$ 此时 $S$ 不变
- 在上个阶段把 $a_i$ 变成 $c$ 的倍数后，每次花掉 $c$ 个优惠券，则 $S\gets S-1$
- 花一次 $[0,c-1]$ 内的优惠券，并使 $S\gets S-1$

从操作性价比考虑，第一个阶段减少为 $0$，优于第二个阶段，而第二个阶段每花掉 $c$ 个优惠券才减少一个，优于第三个阶段。

然后贪心做

## P8340 [AHOI2022] 山河重整

抛出一个我不知道的经典结论：合法当且仅当 $\forall i,\sum_{j\in S,j\le i}j\ge i$。大概可以归纳证明

考虑算不合法的方案数。如果在 $i+1$ 不合法，那么可以发现 $\sum_{j\in S,j\le i}j=i$ 且 $i+1\in S$。

显然这里 $[1,i]$ 的部分和等于 $i$ 的方案数，就是所谓的「互异分拆数」$pd_i$。

其生成函数为
$$
\prod_{i=1}^\infin (1+x^i)
$$

但是这里是要容斥的，貌似做不了

考虑设 $f_i$ 表示前面都合法，但是在 $i+1$ 不合法的方案数。

那么答案就是 $2^n-\sum_{i=1}^{n-1}f_i2^{n-i-1}$。

转移为
$$
f_i=pd_i-\sum_{j=1}^{i-1}f_jpd_{\ge j+2,i-j}
$$

这里 $pd_{\ge k,n}$ 表示用 $\ge k$ 的数凑出 $n$ 的方案数。

其生成函数为
$$
\prod_{i=k}^\infin(1+x^i)
$$

貌似还是做不了。

考虑 Ferrers 图

![Ferrers](https://cdn.luogu.com.cn/upload/image_hosting/t3n1kx0v.png)

每一列表示一个分拆元素。

找到其最大的等腰三角，设其宽度为 $h$，其实就是图的宽。

![also Ferrers](https://cdn.luogu.com.cn/upload/image_hosting/iob890n8.png)

把它删掉然后上端对齐，然后剩下的部分是一个 $n-\frac{(h+1)h}{2}$ 的 Ferrers 图像（普通分拆数），其宽度不超过 $h$。

所以有
$$
\prod_{i=1}^\infin(1+x)^i=\sum_{h=1}^\infin x^{\frac{h(h+1)}{2}}\prod_{i=1}^h\frac{1}{1-x^i}
$$

类似地

$$
\prod_{i=k+1}^{\infin}(1+x^i)=\sum_{h=1}^\infin x^{kh+h(h+1)/2}\prod_{i=1}^h\frac{1}{1-x^i}
$$

所以前面的递推式为

$$
f_i=pd_i-[x^i]\sum_{j=0}^{i-1}f_jx^j\sum_{h=1}^\infin x^{(j+1)h+(h+1)h/2}\prod_{k=1}^h\frac{1}{1-x^k}
$$

注意到 $j$ 只用枚举到 $i/2-1$ 即可。所以考虑倍增式增量。

## CF1129E

神秘交互

这种很自由的交互一般就是构造特殊操作

不妨令 $1$ 为根，那么我们问一遍 $(\{1\},\{1,2,\dots,n\}\backslash\{1,i\},i)$。

然后就能知道 $i$ 的子树大小。

不止于此，我们还能知道一个集合 $S$ 在 $i$ 的子树内的元素的个数。

考虑按子树大小从小到大排序，然后可以二分查询子树内的元素。

如果已经找到父亲，就可以删掉它。因此实际查询出来的是儿子。

所以查询次数是 $O(N\log N)$ 级别的，允许通过。

## P12474 [集训队互测 2024] 生命的循环

考虑「原图强连通」的性质，貌似是经典问题，答案就是所有环的 $\gcd$，我们建 dfs 生成树即可。

然后可以直接缩点，变成每个点有一个周期。

考虑一条从 $1$ 到 $n$ 的路径，其周期即为经过的所有点的 gcd，其相位即为最短路。

如果所有的周期互质，那么答案即为 lcm。

不会做。摆了

## P10084

当时场上看这个一脸懵逼

不妨令

$$
x^a-1=x^{qb+r}-1=(x^b)^qx^r-1
$$

所以可以发现

$$
x^a-1\equiv x^{a\bmod b}-1\pmod {x^b-1}
$$

可以辗转相除得到

$$
F(x,a,b)=x^{\gcd(a,b)}
$$

不妨设 $l=\gcd(a,b),r=\gcd(c,d)$

所以就是问 $(m^l,m^r]$ 的子集和中有多少个是 $m$ 的倍数。

注意到我们只需要考虑每个元素在 mod m 意义下的值，所以等价地看作 $[0,m-1]$ 每个数各有 $m^{r-1}-m^{l-1}$ 个，不妨记为 $n$。

$$
\sum_{m|k}[x^k]\prod_{i=0}^{m-1}(1+x^i)^{n}
$$

有点神秘。

不妨考虑单位根反演
$$
[m|k]=\frac{1}{m}\sum_{i=0}^{m-1}\omega_{m}^{ik}
$$

然后你发现只要套上单位根反演，然后带 $x=\omega_m^i$ 就对了
$$
\frac{1}{m}\sum_{i=0}^{m-1}\prod_{j=0}^{m-1}(1+\omega_m^{ij})^{m^{n-1}}
$$

你发现对于不同的 $i$，$\prod$ 后面的东西只与 $\gcd(i,m)$ 有关。

所以直接枚举 $m/\gcd(i,m)$

$$
\frac{1}{m}\sum_{d|m}\varphi(d)\prod_{j=0}^{d-1}(1+\omega_d^j)^{n}
$$

关键在于求形如
$$
\prod_{i=0}^{n-1}(1+\omega_n^i)
$$

的式子

注意到

$$
x^n-1=\prod_{i=0}^{n-1}(x-\omega_{n}^i)
$$

所以带入 $x=-1$，即得

$$
\prod_{i=0}^{n-1}(1+\omega_n^i)=(-1)^n((-1)^n-1)
$$

分奇偶讨论，发现就等于 $2[2\nmid n]$。

带回去，发现等于

$$
\frac{1}{m}\sum_{d|m}\varphi(d)[2\nmid d]2^{n}
$$

可以直接求。

## AT_agc046_f

限制：不存在三元环指向同一个顶点。

根据经典结论：竞赛图强连缩点的结果是一条链。

可能比较经典的结论：大小为 $n$ 的强连通竞赛图中必然存在大小为 $3$ 到 $n$ 的环。

然后你发现只要一个强连通分量大小 $\ge 3$ 就立刻不合法，但是除了最后一个强连通分量，它可以任意大小。

不看前面的强连通分量，我们把题目转化为要求强连通的情况。

考虑拎出一个点 $1$，则将整个图分为入点 $I$ 和出点 $O$ 两部分，$I$ 与 $O$ 皆非空。

我们发现 $I$ 与 $O$ 的导出子图皆为 DAG。

对于 $I$：

显然竞赛图的导出子图依然是竞赛图，所以只要有环就一定会有三元环，而这些点都是指向 $1$ 的。

对于 $O$：

设对于 $O$ 中的元素 $p$，$S_p=O_p\cap I$。

我们发现对于 $O$ 中元素 $p\to q$，必然存在 $S_p\subseteq S_q$。

这是因为如果存在 $r\in O$，使得 $p\to r$ 且 $r\to q$，则 $(u,p,r)$ 与 $q$ 构成非法结构。

那么我们发现如果存在环，那么环上的 $S$ 都完全相同，如果不存在共同出点，那么只能都是 $\varnothing$。

考虑对 $O$ 做强连缩点得到一条链，由于原图强连通，因此链尾的结点必然指向 $I$，因此链尾必然是单点。

根据上面的结论，除了链尾以外的结点必然是单点。所以我们得到了一个 DAG。

不妨对 $I$ 和 $O$ 按照拓扑序重编号。

那么可能的三元环包括：

- $I,1,O$ 各取一个点。要求 $\max O_x<\min I_x,\forall x\in I$
- $I$ 取两个点，$O$ 取一个点。要求不存在 $x<y\in I$ 使 $\min I_x\cap O_y<\max I_y\cap O_x$。注意到 $\min I_x\le \min I_x\cap O_y<\max I_y\cap O_x\le \max O_x$。所以根据约束 $1$，这种情况不需要考虑。
- $I$ 取一个点，$O$ 取两个点。要求 $\nexists y\in I_x,\min O_x<y<\max O_x,\forall x\in I$。同样不需要考虑。


因此我们需要满足的约束只有：$\max O_x<\min I_x,\forall x\in I$，以及 $O$ 的链尾一定指向 $I$ 的链头。

因此总方案数为 $(|O|+1)^{|I|-1}|O|$。

